<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dare to Read ‚Äì H√†nh tr√¨nh 21 ng√†y ƒë·ªçc s√°ch</title>
  <style>
    :root{
      --vtb-blue:#003A8C;
      --vtb-cyan:#00AEEF;
      --vtb-red:#E60012;

      --ink:#0b1220;
      --card: rgba(255,255,255,.90);
      --muted: rgba(11,18,32,.55);
      --shadow: 0 18px 50px rgba(0,0,0,.18);
      --radius: 18px;
      --dark: rgba(11,18,32,.92);
    }

    /* ===== Base ===== */
    html,body{
      height:100%; margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#0b1220;
      -webkit-text-size-adjust: 100%;
    }
    #wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      box-sizing:border-box;
    }
    #stage{
      width:min(1100px, 96vw);
      aspect-ratio: 16 / 9;
      background:
        radial-gradient(900px 520px at 20% 20%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(780px 520px at 85% 25%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(135deg, var(--vtb-blue), var(--vtb-cyan), var(--vtb-red));
      border-radius: 22px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    #ui{
      position:absolute;
      inset:0;
      pointer-events:none;
    }

    .panel{
      position:absolute;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      padding: 16px 16px 14px;
      color: var(--ink);
      pointer-events:auto;
      backdrop-filter: blur(10px);
      outline:1px solid rgba(255,255,255,.35);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .col{display:flex; flex-direction:column; gap:8px;}
    .title{font-weight:800; letter-spacing:.2px;}
    .subtitle{color:var(--muted); font-size:12px; line-height:1.35;}
    .kpi{display:flex; gap:10px; flex-wrap:wrap;}
    .pill{
      background: rgba(255,255,255,.75);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      color: rgba(11,18,32,.85);
      border:1px solid rgba(11,18,32,.08);
    }

    input, textarea, select{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(11,18,32,.14);
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
      box-sizing:border-box;
      background: rgba(255,255,255,.92);
      color: var(--ink);
    }
    textarea{min-height: 118px; resize: vertical;}
    .hint{font-size:12px; color: rgba(11,18,32,.65);}

    .btn{
      border: 0;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      transition: transform .07s ease;
      user-select:none;
      white-space:nowrap;
      touch-action: manipulation;
    }
    .btn:active{transform: translateY(1px) scale(.99);}
    .btn.dark{background: var(--dark); color:white;}
    .btn.soft{
      background: rgba(255,255,255,.78);
      color: var(--ink);
      border:1px solid rgba(11,18,32,.10);
      box-shadow:none;
    }
    .btn.warn{background: linear-gradient(135deg, #fb7185, #f97316); color:white;}
    .btn.small{padding:8px 10px; border-radius: 12px; font-size: 12px; box-shadow:none;}
    .btn.link{background: transparent; box-shadow:none; border:1px dashed rgba(11,18,32,.18); color: rgba(11,18,32,.85);}

    .seg{
      display:flex;
      gap:8px;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(11,18,32,.10);
      padding:6px;
      border-radius: 999px;
    }
    .seg button{
      border:0;
      cursor:pointer;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      background: transparent;
      color: rgba(11,18,32,.72);
      touch-action: manipulation;
    }
    .seg button.active{
      background: var(--dark);
      color: white;
    }
    .divider{height:1px; background: rgba(11,18,32,.10); margin:10px 0;}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 9px;
      border-radius: 999px;
      border:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.75);
      font-size:12px;
      font-weight:900;
    }
    .toast{
      position:absolute;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      background: rgba(11,18,32,.90);
      color:white;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      max-width:min(860px, 90%);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px);}
    .corner{
      position:absolute;
      top:12px;
      right:12px;
      display:flex;
      gap:8px;
      pointer-events:auto;
      z-index:3;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    .daybtn{
      width:100%;
      padding: 10px 8px;
      border-radius: 16px;
      border:1px solid rgba(11,18,32,.10);
      box-shadow:none;
      position:relative;
      overflow:hidden;
    }
    @keyframes glow {
      0% { box-shadow: 0 0 0 rgba(255,255,255,0), 0 0 0 rgba(0,0,0,0); transform: translateY(0); }
      50% { box-shadow: 0 0 0 4px rgba(255,255,255,.25), 0 10px 18px rgba(0,0,0,.12); transform: translateY(-1px); }
      100% { box-shadow: 0 0 0 rgba(255,255,255,0), 0 0 0 rgba(0,0,0,0); transform: translateY(0); }
    }
    .daybtn.activePulse{
      animation: glow 1.25s ease-in-out infinite;
    }

    .brandHeader{
      position:absolute;
      left:18px;
      top:14px;
      pointer-events:none;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.14);
      outline: 1px solid rgba(255,255,255,.20);
      color: rgba(255,255,255,.95);
      backdrop-filter: blur(8px);
      z-index:2;
    }
    .brandHeader .h1{font-weight:900; letter-spacing:.2px;}
    .brandHeader .h2{font-size:12px; opacity:.92;}

    .quoteCard{
      text-align:left;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(11,18,32,.10);
      border-radius: 16px;
      padding: 12px 12px 10px;
    }
    .quoteText{
      font-size:14px;
      font-weight:800;
      color: rgba(11,18,32,.92);
      line-height:1.35;
    }
    .quoteAuthor{
      margin-top:6px;
      font-size:12px;
      color: rgba(11,18,32,.62);
      font-weight:800;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(11,18,32,.10);
      background:rgba(255,255,255,.75);
    }
    th,td{
      font-size:12px;
      padding:8px 10px;
      border-bottom:1px solid rgba(11,18,32,.08);
      text-align:left;
      vertical-align:top;
    }
    thead th{
      background:rgba(255,255,255,.65);
      font-weight:900;
    }
    tbody tr:last-child td{border-bottom:0;}

    /* ===== Mobile-first improvements (display only) ===== */
    @media (max-width: 720px){
      #wrap{
        padding:10px;
        align-items:stretch;
        justify-content:stretch;
      }
      #stage{
        width:100%;
        height: calc(100dvh - 20px);
        aspect-ratio: auto;
        border-radius: 16px;
      }

      /* Safe area */
      .brandHeader{
        left:12px;
        top: calc(10px + env(safe-area-inset-top));
        padding: 9px 10px;
        border-radius: 14px;
        max-width: calc(100% - 24px);
      }
      .brandHeader .h1{font-size:14px;}
      .brandHeader .h2{font-size:11px;}

      .corner{
        top: calc(10px + env(safe-area-inset-top));
        right: 10px;
        gap:6px;
        flex-wrap:wrap;
        justify-content:flex-end;
        max-width: 60%;
      }
      .corner .btn.small{padding:10px 10px; font-size:12px; border-radius: 14px;}

      /* Make panels readable and scrollable on phone */
      #ui .panel{
        left: 12px !important;
        right: 12px !important;
        top: calc(56px + env(safe-area-inset-top)) !important;
        bottom: calc(14px + env(safe-area-inset-bottom)) !important;
        width: auto !important;
        transform: none !important;
        max-height: none !important;
        overflow: auto !important;
        -webkit-overflow-scrolling: touch;
        padding: 14px 14px 12px;
      }

      /* Inputs: 16px to prevent iOS zoom */
      input, textarea, select{ font-size:16px; }
      textarea{ min-height: 140px; }

      /* Buttons bigger tap targets */
      .btn{ padding: 12px 12px; border-radius: 16px; }
      .btn.small{ padding: 10px 10px; font-size: 13px; border-radius: 14px; }

      /* Home day grid: override inline 7 columns */
      div[style*="grid-template-columns: repeat(7"]{
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 8px !important;
      }
      .daybtn{ padding: 12px 8px; }

      /* Toast safe area */
      .toast{
        bottom: calc(12px + env(safe-area-inset-bottom));
        max-width: calc(100% - 24px);
      }

      /* Tables: allow horizontal scroll if needed */
      table{ display:block; overflow-x:auto; -webkit-overflow-scrolling:touch; }
      thead, tbody, tr{ width:100%; }
    }

    @media (max-width: 360px){
      div[style*="grid-template-columns: repeat(7"]{
        grid-template-columns: repeat(3, 1fr) !important;
      }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="stage">
      <div class="brandHeader">
        <div>
          <div class="h1">üìö Dare to Read</div>
          <div class="h2">H√†nh tr√¨nh 21 ng√†y ƒë·ªçc s√°ch</div>
        </div>
      </div>
      <div id="ui"></div>
      <div id="toast" class="toast"></div>
    </div>
  </div>

  <script>
    (() => {
      // ===== CONFIG =====
      const CONFIG = {
        GAME_NAME: "Dare to Read ‚Äì H√†nh tr√¨nh 21 ng√†y ƒë·ªçc s√°ch",
        DAYS: 21,
        DEFAULT_PASS: "1234",
        ADMIN_PASS: "Ab123456",
        STORAGE_KEY: "dare_to_read_v3_fixed",
        WEBHOOK_URL: "https://script.google.com/macros/s/AKfycbyqik0-6CFcH2_EFkvcXt_z4ChSaW5T3LWl9KVZyA4TrWBc4G59ptF6YHur-pgi8Gli/exec",
        MAX_SHARE_CHARS: 700,
        QUOTES: [
          { text: "M·ªôt cƒÉn ph√≤ng kh√¥ng c√≥ s√°ch gi·ªëng nh∆∞ m·ªôt th√¢n th·ªÉ kh√¥ng c√≥ linh h·ªìn.", author: "Cicero" },
          { text: "ƒê·ªçc s√°ch l√† c√°ch r·∫ª nh·∫•t ƒë·ªÉ du l·ªãch ‚Äî v√† c≈©ng l√† c√°ch s√¢u nh·∫•t ƒë·ªÉ tr∆∞·ªüng th√†nh.", author: "Khuy·∫øt danh" },
          { text: "S√°ch l√† t·∫•m g∆∞∆°ng: b·∫°n ch·ªâ nh√¨n th·∫•y trong ƒë√≥ ƒëi·ªÅu b·∫°n ƒë√£ mang s·∫µn b√™n m√¨nh.", author: "Carlos Ruiz Zaf√≥n" },
          { text: "H√¥m nay m·ªôt ng∆∞·ªùi ƒë·ªçc, ng√†y mai m·ªôt ng∆∞·ªùi l√£nh ƒë·∫°o.", author: "Margaret Fuller" },
          { text: "B·∫°n kh√¥ng c·∫ßn ƒë·ªçc th·∫≠t nhi·ªÅu‚Äîch·ªâ c·∫ßn ƒë·ªçc ƒë√∫ng v√† l√†m ƒë·∫øn n∆°i.", author: "Khuy·∫øt danh" },
          { text: "ƒê·ªçc s√°ch kh√¥ng l√†m b·∫°n gi√†u ngay, nh∆∞ng l√†m b·∫°n gi√†u n·ªôi l·ª±c.", author: "Khuy·∫øt danh" }
        ],
      };

      // ===== DOM =====
      const ui = document.getElementById("ui");
      const toastEl = document.getElementById("toast");

      // ===== Utils =====
      const now = () => Date.now();
      const esc = (s) => String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");

      function showToast(msg, ms=2200){
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => toastEl.classList.remove("show"), ms);
      }

      function normalizeUserAd(input){
        let u = (input || "").trim();
        u = u.replace(/\s+/g, "");
        u = u.replace(/@vietinbank\.vn$/i, "");
        return u;
      }

      function makeFreshProgress(createdAtTs = now()){
        return { points: 0, reachedAt: { "0": createdAtTs }, days: {} };
      }

      function seedState(){
        return {
          settings: { webhookUrl: CONFIG.WEBHOOK_URL, lastExportAt: 0 },
          users: {
            demo01: { pass: CONFIG.DEFAULT_PASS, avatar:"M", createdAt: now()-3*86400000 },
            demo02: { pass: CONFIG.DEFAULT_PASS, avatar:"F", createdAt: now()-2*86400000 },
          },
          progress: {
            demo01: makeFreshProgress(now()-3*86400000),
            demo02: makeFreshProgress(now()-2*86400000),
          },
          session: { currentUser: null, isAdmin:false },
          sync: { status: {} },
          lastQuote: null
        };
      }

      function loadState(){
        try{
          const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        }catch(e){
          return null;
        }
      }
      function saveState(){ localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state)); }

      let state = loadState() || seedState();
      saveState();

      function ensureUser(user){
        if (!state.users[user]) state.users[user] = { pass: CONFIG.DEFAULT_PASS, avatar:"M", createdAt: now() };
        if (!state.progress[user]) state.progress[user] = makeFreshProgress(state.users[user].createdAt || now());
      }

      function currentUser(){ return state.session.currentUser; }
      function isLoggedIn(){ return !!currentUser() && !!state.users[currentUser()]; }

      function getNextPlayableDay(user){
        const prog = state.progress[user];
        for (let d=1; d<=CONFIG.DAYS; d++){
          if (!prog.days[d]) return d;
        }
        return CONFIG.DAYS;
      }

      function dayStatus(user, d){
        const prog = state.progress[user];
        const next = getNextPlayableDay(user);
        if (prog.days[d]) return "DONE";
        if (d === next) return "ACTIVE";
        return "LOCKED";
      }

      function computeLeaderboard(){
        const rows = Object.keys(state.users).map(u=>{
          ensureUser(u);
          const p = state.progress[u];
          const pts = p.points || 0;
          const reached = (p.reachedAt && p.reachedAt[String(pts)]) ? p.reachedAt[String(pts)] : (state.users[u].createdAt || now());
          return { user:u, points:pts, reachedAt:reached };
        });
        rows.sort((a,b)=>{
          if (b.points !== a.points) return b.points - a.points;
          if (a.reachedAt !== b.reachedAt) return a.reachedAt - b.reachedAt;
          return a.user.localeCompare(b.user);
        });
        return rows;
      }
      function userRank(user){
        const lb = computeLeaderboard();
        const idx = lb.findIndex(r => r.user === user);
        return idx >= 0 ? idx+1 : lb.length;
      }

      function pickQuote(){
        return CONFIG.QUOTES[Math.floor(Math.random()*CONFIG.QUOTES.length)]
          || { text:"ƒê·ªçc m·ªói ng√†y m·ªôt ch√∫t, b·∫°n s·∫Ω ƒëi r·∫•t xa.", author:"Khuy·∫øt danh" };
      }

      // ===== Webhook (·∫©n UI) =====
      function getWebhookUrl(){
        const url = (state.settings.webhookUrl || CONFIG.WEBHOOK_URL || "").trim();
        return url;
      }

      async function sendToWebhook(payload){
        const url = getWebhookUrl();
        if (!url || !url.startsWith("https://")) return { ok:false, reason:"NO_URL" };
        try{
          await fetch(url, {
            method:"POST",
            mode:"no-cors",
            headers:{ "Content-Type":"text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
          });
          return { ok:true, uncertain:true };
        }catch(e){
          return { ok:false, reason:String(e) };
        }
      }

      function setSyncStatus(user, day, ok){
        const key = `${user}:${day}`;
        state.sync.status[key] = { ok: !!ok, at: now() };
        saveState();
      }

      // ===== Tiny DOM builder =====
      function clearUI(){ ui.innerHTML = ""; }

      function h(tag, attrs = {}, children = []){
        const e = document.createElement(tag);
        for (const [k,v] of Object.entries(attrs)){
          if (k === "class") e.className = v;
          else if (k === "style") e.setAttribute("style", v);
          else if (k === "html") e.innerHTML = v;
          else if (k.startsWith("on") && typeof v === "function") e.addEventListener(k.slice(2), v);
          else e.setAttribute(k, v);
        }
        children.forEach(c => e.appendChild(c));
        return e;
      }

      // ===== Router =====
      const View = { LOGIN:"LOGIN", HOME:"HOME", DAY:"DAY", DONE:"DONE", ADMIN_LOGIN:"ADMIN_LOGIN", ADMIN:"ADMIN" };
      let view = View.LOGIN;
      let selectedAvatar = "M";
      let currentDay = 1;
      let lastDoneInfo = null;
      let adminTab = "ACCOUNTS"; // ACCOUNTS | WEBHOOK | DASH | RESET

      // ===== Views =====
      function buildLogin(){
        clearUI();
        const panel = h("div", { class:"panel", style:"left:50%; top:50%; transform:translate(-50%,-50%); width:min(520px, 92%);" });

        const title = h("div", { class:"title", style:"font-size:18px; margin-bottom:6px;", html:`üéÆ ${esc(CONFIG.GAME_NAME)}` });
        const sub = h("div", { class:"subtitle", html:`ƒêƒÉng nh·∫≠p b·∫±ng <b>User AD</b>. L∆∞u √Ω: <b>kh√¥ng nh·∫≠p @vietinbank.vn</b>.` });

        const seg = h("div", { class:"seg", style:"margin-top:12px;" }, [
          h("button", { class:"active", id:"segM", html:"üë® Nam", onclick:()=>setAvatar("M") }),
          h("button", { id:"segF", html:"üë© N·ªØ", onclick:()=>setAvatar("F") }),
        ]);

        const userInput = h("input", { placeholder:"User AD (vd: nguyenvana)", autocomplete:"username" });
        const hint = h("div", { class:"hint", html:"G·ª£i √Ω: Kh√¥ng nh·∫≠p ‚Äú@vietinbank.vn‚Äù" });
        const passInput = h("input", { type:"password", placeholder:`Password (m·∫∑c ƒë·ªãnh: ${CONFIG.DEFAULT_PASS})`, autocomplete:"current-password", value: CONFIG.DEFAULT_PASS });

        const btnRow = h("div", { class:"row", style:"margin-top:12px; justify-content:space-between;" }, [
          h("button", { class:"btn dark", html:"ƒêƒÇNG NH·∫¨P", onclick:()=>doLogin(userInput.value, passInput.value) }),
          h("button", { class:"btn link small", html:"Admin", onclick:()=>{ view = View.ADMIN_LOGIN; render(); } }),
        ]);

        panel.append(title, sub, seg, h("div",{style:"height:10px;"}), userInput, hint, h("div",{style:"height:8px;"}), passInput, btnRow);
        ui.appendChild(panel);

        function setAvatar(a){
          selectedAvatar = a;
          panel.querySelector("#segM").classList.toggle("active", a==="M");
          panel.querySelector("#segF").classList.toggle("active", a==="F");
        }
      }

      function doLogin(userAdRaw, passRaw){
        const user = normalizeUserAd(userAdRaw);
        const pass = (passRaw || "").trim();
        if (!user) return showToast("Vui l√≤ng nh·∫≠p User AD.");
        const u = state.users[user];
        if (!u) return showToast("T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c admin t·∫°o.");
        if ((u.pass || CONFIG.DEFAULT_PASS) !== pass) return showToast("Password kh√¥ng ƒë√∫ng.");

        state.users[user].avatar = selectedAvatar;
        ensureUser(user);

        state.session.currentUser = user;
        state.session.isAdmin = false;
        saveState();

        view = View.HOME;
        currentDay = getNextPlayableDay(user);
        showToast(`Xin ch√†o ${user}! Ch√∫c b·∫°n m·ªôt ng√†y ƒë·ªçc hi·ªáu qu·∫£ ‚ú®`);
        render();
      }

      function buildHome(){
        clearUI();
        const user = currentUser();
        if (!user) { view = View.LOGIN; return render(); }
        ensureUser(user);

        const prog = state.progress[user];
        const pts = prog.points || 0;
        const rank = userRank(user);
        const nextDay = getNextPlayableDay(user);

        const corner = h("div", { class:"corner" }, [
          h("button", { class:"btn soft small", html:"ƒêƒÉng xu·∫•t", onclick:()=>{ state.session.currentUser=null; saveState(); view=View.LOGIN; render(); } }),
          h("button", { class:"btn link small", html:"Admin", onclick:()=>{ view=View.ADMIN_LOGIN; render(); } }),
        ]);
        ui.appendChild(corner);

        const home = h("div", { class:"panel", style:"left:50%; top:50%; transform:translate(-50%,-50%); width:min(920px, 94%); max-height: calc(100% - 64px); overflow:auto;" });

        // Info
        home.append(
          h("div", { class:"row", style:"justify-content:space-between; align-items:flex-start;" }, [
            h("div", { class:"col", style:"gap:6px;" }, [
              h("div", { class:"title", style:"font-size:16px;", html:`üëã ${esc(user)}` }),
              h("div", { class:"subtitle", html:`Avatar: <b>${state.users[user].avatar==="F" ? "N·ªØ üë©" : "Nam üë®"}</b>` }),
            ]),
            h("div", { class:"badge", html:`‚≠ê ${pts} ƒëi·ªÉm` })
          ])
        );

        home.append(
          h("div", { class:"kpi", style:"margin-top:10px;" }, [
            h("div", { class:"pill", html:`üèÖ Th·ª© h·∫°ng: <b>#${rank}</b>` }),
            h("div", { class:"pill", html:`üìÖ Ng√†y hi·ªán t·∫°i: <b>${nextDay}/${CONFIG.DAYS}</b>` }),
            h("div", { class:"pill", html:`‚úÖ ƒê√£ ho√†n th√†nh: <b>${Object.keys(prog.days).length}/${CONFIG.DAYS}</b>` }),
          ])
        );

        home.append(h("div", { class:"divider" }));
        home.append(h("div", { class:"subtitle", html:"M·ª•c ti√™u: duy tr√¨ th√≥i quen ƒë·ªçc m·ªói ng√†y v√† ghi l·∫°i 1 ƒëi·ªÅu t√¢m ƒë·∫Øc ƒë·ªÉ √°p d·ª•ng v√†o c√¥ng vi·ªác/cu·ªôc s·ªëng." }));

        // Journey
        home.append(h("div", { class:"divider" }));
        home.append(
          h("div", { class:"row", style:"justify-content:space-between; align-items:flex-start;" }, [
            h("div", { class:"col", style:"gap:4px;" }, [
              h("div", { class:"title", style:"font-size:16px;", html:"üó∫Ô∏è H√†nh tr√¨nh 21 ng√†y" }),
              h("div", { class:"subtitle", html:"Ch·ªâ c√≥ <b>Ng√†y hi·ªán t·∫°i</b> ƒë∆∞·ª£c b·∫•m ƒë·ªÉ chia s·∫ª. Ho√†n th√†nh s·∫Ω c·ªông <b>‚≠ê 1 ƒëi·ªÉm</b>." }),
            ]),
            h("button", { class:"btn dark small", html:`V√†o Ng√†y ${nextDay}`, onclick:()=>{ currentDay = nextDay; view=View.DAY; render(); } })
          ])
        );

        const grid = h("div", { style:"display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-top:12px;" });
        for (let d=1; d<=CONFIG.DAYS; d++){
          const st = dayStatus(user, d);
          const isDone = st === "DONE";
          const isActive = st === "ACTIVE";
          const isLocked = st === "LOCKED";
          const icon = isDone ? "‚úÖ" : (isActive ? "‚ú®" : "‚è≥");

          const btn = h("button", {
            class: `btn small daybtn ${isActive ? "activePulse" : ""}`,
            style: `background:${isDone ? "rgba(255,255,255,.82)" : (isActive ? "rgba(11,18,32,.92)" : "rgba(255,255,255,.45)")};
                    color:${isDone ? "rgba(11,18,32,.92)" : (isActive ? "#fff" : "rgba(11,18,32,.55)")};
                    opacity:${isLocked ? ".55" : "1"};
                    cursor:${isActive ? "pointer" : "not-allowed"};`,
            onclick: ()=> {
              if (!isActive) return showToast("B·∫°n ch·ªâ c√≥ th·ªÉ th·ª±c hi·ªán Ng√†y hi·ªán t·∫°i.");
              currentDay = d; view = View.DAY; render();
            }
          });
          btn.innerHTML = `<span class="mono">Ng√†y ${d}</span><div style="font-size:16px; margin-top:4px;">${icon}</div>`;
          grid.appendChild(btn);
        }
        home.append(grid);

        home.append(
          h("div", { class:"row", style:"gap:8px; margin-top:10px; flex-wrap:wrap;" }, [
            h("div", { class:"pill", html:"‚úÖ ƒê√£ ho√†n th√†nh" }),
            h("div", { class:"pill", html:"‚ú® Ng√†y hi·ªán t·∫°i (nh·∫•p nh√°y)" }),
            h("div", { class:"pill", html:"‚è≥ Ch∆∞a t·ªõi (m·ªù)" }),
          ])
        );

        ui.appendChild(home);
      }

      function buildDay(){
        clearUI();
        const user = currentUser();
        if (!user) { view = View.LOGIN; return render(); }
        ensureUser(user);

        const next = getNextPlayableDay(user);
        if (currentDay !== next) currentDay = next;

        const prog = state.progress[user];
        if (prog.days[currentDay]) { view = View.HOME; return render(); }

        const corner = h("div", { class:"corner" }, [
          h("button", { class:"btn soft small", html:"‚¨Ö Trang ch·ªß", onclick:()=>{ view=View.HOME; render(); } }),
          h("button", { class:"btn soft small", html:"ƒêƒÉng xu·∫•t", onclick:()=>{ state.session.currentUser=null; saveState(); view=View.LOGIN; render(); } }),
        ]);
        ui.appendChild(corner);

        const panel = h("div", { class:"panel", style:"left:50%; top:50%; transform:translate(-50%,-50%); width:min(820px, 94%);" });

        panel.append(
          h("div", { class:"row", style:"justify-content:space-between; align-items:flex-start;" }, [
            h("div", { class:"col", style:"gap:4px;" }, [
              h("div", { class:"title", style:"font-size:18px;", html:`üìö Ng√†y ${currentDay} ‚Äì Dare to Read` }),
              h("div", { class:"subtitle", html:`Anh/Ch·ªã h√£y chia s·∫ª ƒëi·ªÅu t√¢m ƒë·∫Øc nh·∫•t c·ªßa bu·ªïi ƒë·ªçc s√°ch h√¥m nay. <b>M·ªói chia s·∫ª h·ª£p l·ªá = ‚≠ê 1 ƒëi·ªÉm</b>.` })
            ]),
            h("div", { class:"badge", html:"‚≠ê +1 ƒëi·ªÉm" })
          ])
        );

        panel.append(h("div", { class:"divider" }));

        const textarea = h("textarea", {
          maxlength: String(CONFIG.MAX_SHARE_CHARS),
          placeholder: "Vi·∫øt ng·∫Øn g·ªçn, r√µ √Ω (g·ª£i √Ω 2‚Äì6 c√¢u):\n‚Ä¢ ƒêi·ªÅu g√¨ khi·∫øn b·∫°n t√¢m ƒë·∫Øc?\n‚Ä¢ B·∫°n s·∫Ω √°p d·ª•ng nh∆∞ th·∫ø n√†o?"
        });
        const counter = h("div", { class:"hint", style:"text-align:right; margin-top:6px;", html:`0/${CONFIG.MAX_SHARE_CHARS}` });
        textarea.addEventListener("input", () => counter.innerHTML = `${textarea.value.length}/${CONFIG.MAX_SHARE_CHARS}`);

        const btnRow = h("div", { class:"row", style:"margin-top:12px; justify-content:flex-end;" }, [
          h("button", { class:"btn dark", html:"K·∫æT TH√öC NG√ÄY H√îM NAY", onclick:()=>finishDay(textarea.value) })
        ]);

        panel.append(textarea, counter, btnRow);
        ui.appendChild(panel);
      }

      async function finishDay(contentRaw){
        const user = currentUser();
        if (!user) return;

        const content = (contentRaw || "").trim();
        if (content.length < 10) return showToast("N·ªôi dung h∆°i ng·∫Øn. Vui l√≤ng chia s·∫ª √≠t nh·∫•t ~10 k√Ω t·ª±.");
        if (content.length > CONFIG.MAX_SHARE_CHARS) return showToast("N·ªôi dung v∆∞·ª£t gi·ªõi h·∫°n k√Ω t·ª±.");

        const prog = state.progress[user];
        const day = currentDay;
        if (prog.days[day]) return showToast("Ng√†y n√†y ƒë√£ ho√†n th√†nh.");

        const completedAt = now();

        // Save local
        prog.days[day] = { content, completedAt, point: 1 };
        prog.points = (prog.points || 0) + 1;

        const pts = prog.points;
        prog.reachedAt = prog.reachedAt || {};
        if (!prog.reachedAt[String(pts)] || completedAt < prog.reachedAt[String(pts)]) {
          prog.reachedAt[String(pts)] = completedAt;
        }

        state.lastQuote = pickQuote();
        saveState();

        // Send to Sheet (·∫©n UI)
        const payload = {
          user, day, content,
          point: 1,
          totalPointAfter: prog.points,
          completedAtISO: new Date(completedAt).toISOString()
        };
        const sent = await sendToWebhook(payload);
        setSyncStatus(user, day, !!sent.ok);

        lastDoneInfo = { day, pointsGained: 1 };
        view = View.DONE;
        render();
      }

      function buildDone(){
        clearUI();
        const user = currentUser();
        if (!user) { view = View.LOGIN; return render(); }
        ensureUser(user);

        const info = lastDoneInfo || { day: currentDay, pointsGained: 1 };
        const quote = state.lastQuote || pickQuote();

        const panel = h("div", { class:"panel", style:"left:50%; top:50%; transform:translate(-50%,-50%); width:min(680px, 92%); text-align:center;" });

        panel.append(
          h("div", { class:"title", style:"font-size:20px;", html:`üéâ Ho√†n th√†nh Ng√†y ${info.day}!` }),
          h("div", { class:"subtitle", style:"margin-top:6px;", html:"B·∫°n v·ª´a ghi l·∫°i ƒëi·ªÅu t√¢m ƒë·∫Øc c·ªßa h√¥m nay." }),
          h("div", { class:"kpi", style:"justify-content:center; margin-top:10px;" }, [
            h("div", { class:"pill", html:`‚≠ê ƒêi·ªÉm h√¥m nay: <b>+${info.pointsGained}</b>` }),
            h("div", { class:"pill", html:`üìÖ Ti·∫øp theo: <b>Ng√†y ${Math.min(info.day+1, CONFIG.DAYS)}</b>` }),
          ]),
          h("div", { class:"divider" }),
          h("div", { class:"quoteCard" }, [
            h("div", { class:"subtitle", style:"margin-bottom:6px;", html:"üí¨ Th·∫ª truy·ªÅn c·∫£m h·ª©ng v·ªÅ ƒë·ªçc s√°ch" }),
            h("div", { class:"quoteText", html:`‚Äú${esc(quote.text)}‚Äù` }),
            h("div", { class:"quoteAuthor", html:`‚Äî ${esc(quote.author)}` }),
          ]),
          h("div", { class:"row", style:"justify-content:center; margin-top:12px;" }, [
            h("button", { class:"btn dark", html:"Quay v·ªÅ Trang ch·ªß", onclick:()=>{ view=View.HOME; render(); } }),
            h("button", { class:"btn soft", html:"ƒê·ªïi th·∫ª c√¢u n√≥i", onclick:()=>{ state.lastQuote = pickQuote(); saveState(); render(); } }),
          ])
        );

        ui.appendChild(panel);
      }

      function buildAdminLogin(){
        clearUI();
        const panel = h("div", { class:"panel", style:"left:50%; top:50%; transform:translate(-50%,-50%); width:min(520px, 92%);" });

        panel.append(
          h("div", { class:"title", style:"font-size:18px; margin-bottom:6px;", html:"üîß Admin ‚Äì Thi·∫øt l·∫≠p Game" }),
          h("div", { class:"subtitle", html:`Nh·∫≠p m·∫≠t kh·∫©u admin ƒë·ªÉ v√†o thi·∫øt l·∫≠p.` })
        );

        const pass = h("input", { type:"password", placeholder:"Nh·∫≠p m·∫≠t kh·∫©u admin" });
        const row = h("div", { class:"row", style:"margin-top:12px; justify-content:space-between;" }, [
          h("button", { class:"btn soft", html:"‚¨Ö Quay l·∫°i", onclick:()=>{ view = isLoggedIn() ? View.HOME : View.LOGIN; render(); } }),
          h("button", { class:"btn dark", html:"V√ÄO THI·∫æT L·∫¨P", onclick:()=>{
            if ((pass.value||"").trim() !== CONFIG.ADMIN_PASS) return showToast("Sai m·∫≠t kh·∫©u admin.");
            state.session.isAdmin = true; saveState();
            view = View.ADMIN; adminTab = "ACCOUNTS"; render();
          }}),
        ]);
        panel.append(h("div",{style:"height:10px;"}), pass, row);
        ui.appendChild(panel);
      }

      function buildAdmin(){
        clearUI();
        state.session.isAdmin = true;

        const corner = h("div", { class:"corner" }, [
          h("button", { class:"btn soft small", html:"‚¨Ö Quay l·∫°i", onclick:()=>{ view = isLoggedIn() ? View.HOME : View.LOGIN; render(); } }),
        ]);
        ui.appendChild(corner);

        const shell = h("div", { class:"panel", style:"left:18px; top:18px; width: calc(100% - 36px); height: calc(100% - 36px); overflow:auto;" });

        shell.append(
          h("div", { class:"row", style:"justify-content:space-between; align-items:flex-start;" }, [
            h("div", { class:"col", style:"gap:4px;" }, [
              h("div", { class:"title", style:"font-size:18px;", html:"üîß Admin Console ‚Äì Dare to Read" }),
              h("div", { class:"subtitle", html:"Qu·∫£n l√Ω t√†i kho·∫£n, c·∫•u h√¨nh Web App (ghi Sheet), dashboard, reset." })
            ]),
            h("div", { class:"row", style:"gap:8px;" }, [
              h("button", { class:`btn small ${adminTab==="ACCOUNTS"?"dark":"soft"}`, html:"üë• T√†i kho·∫£n", onclick:()=>{ adminTab="ACCOUNTS"; render(); } }),
              h("button", { class:`btn small ${adminTab==="WEBHOOK"?"dark":"soft"}`, html:"üßæ Web App / Sheet", onclick:()=>{ adminTab="WEBHOOK"; render(); } }),
              h("button", { class:`btn small ${adminTab==="DASH"?"dark":"soft"}`, html:"üìä Dashboard", onclick:()=>{ adminTab="DASH"; render(); } }),
              h("button", { class:`btn small ${adminTab==="RESET"?"warn":"soft"}`, html:"‚ôª Reset", onclick:()=>{ adminTab="RESET"; render(); } }),
            ])
          ])
        );

        shell.append(h("div", { class:"divider" }));

        if (adminTab === "ACCOUNTS") shell.append(adminAccountsPanel());
        if (adminTab === "WEBHOOK") shell.append(adminWebhookPanel());
        if (adminTab === "DASH") shell.append(adminDashPanel());
        if (adminTab === "RESET") shell.append(adminResetPanel());

        ui.appendChild(shell);
      }

      // ===== Admin panels =====
      function adminAccountsPanel(){
        const wrap = h("div", { class:"col", style:"gap:12px; position:relative;" });

        const card = h("div", { style:"padding:14px; border-radius:18px; background:rgba(255,255,255,.70); outline:1px solid rgba(255,255,255,.35);" });
        card.append(h("div",{class:"title", html:"T·∫°o / c·∫≠p nh·∫≠t t√†i kho·∫£n"}));

        const user = h("input", { placeholder:"User AD (kh√¥ng @vietinbank.vn)" });
        const pass = h("input", { placeholder:`Password (m·∫∑c ƒë·ªãnh ${CONFIG.DEFAULT_PASS})`, value: CONFIG.DEFAULT_PASS });
        const avatar = h("select", {}, [
          h("option", { value:"M", html:"Nam üë®" }),
          h("option", { value:"F", html:"N·ªØ üë©" }),
        ]);
        const btn = h("button", { class:"btn dark", html:"T·∫°o / C·∫≠p nh·∫≠t", onclick:()=>{
          const u = normalizeUserAd(user.value);
          if (!u) return showToast("Thi·∫øu User AD.");
          const p = (pass.value || CONFIG.DEFAULT_PASS).trim() || CONFIG.DEFAULT_PASS;
          const a = (String(avatar.value||"M").trim().toUpperCase()==="F") ? "F" : "M";
          state.users[u] = { pass: p, avatar: a, createdAt: state.users[u]?.createdAt || now() };
          ensureUser(u);
          saveState();
          showToast(`ƒê√£ t·∫°o/c·∫≠p nh·∫≠t: ${u}`);
          render();
        }});
        card.append(h("div",{style:"height:8px;"}), user, h("div",{style:"height:8px;"}), pass, h("div",{style:"height:8px;"}), avatar, h("div",{style:"height:10px;"}), btn);

        const card2 = h("div", { style:"padding:14px; border-radius:18px; background:rgba(255,255,255,.70); outline:1px solid rgba(255,255,255,.35);" });
        card2.append(
          h("div",{class:"title", html:"Import / Export CSV (Excel)"}),
          h("div",{class:"subtitle", html:`M·∫´u CSV: <span class="mono">user,password,avatar</span> (avatar = M ho·∫∑c F).`})
        );
        const downTpl = h("button", { class:"btn soft", html:"‚¨á T·∫£i m·∫´u CSV", onclick:downloadTemplateCSV });
        const file = h("input", { type:"file", accept:".csv,text/csv" });
        const importBtn = h("button", { class:"btn dark", html:"‚¨Ü Import CSV", onclick:()=>importCSV(file.files?.[0]) });
        card2.append(h("div",{style:"height:10px;"}), h("div",{class:"row"}, [downTpl, importBtn]), h("div",{style:"height:8px;"}), file);

        const card3 = h("div", { style:"padding:14px; border-radius:18px; background:rgba(255,255,255,.70); outline:1px solid rgba(255,255,255,.35);" });
        card3.append(h("div",{class:"title", html:"Danh s√°ch t√†i kho·∫£n"}));

        const tbody = h("tbody");
        const usersSorted = Object.keys(state.users).sort((a,b)=>a.localeCompare(b));
        for (const u of usersSorted){
          ensureUser(u);
          const p = state.progress[u];
          const doneCount = Object.keys(p.days).length;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="mono">${esc(u)}</span></td>
            <td>${state.users[u].avatar==="F" ? "N·ªØ üë©" : "Nam üë®"}</td>
            <td>‚≠ê ${p.points||0}</td>
            <td>üìÖ ${doneCount}/${CONFIG.DAYS}</td>
            <td></td>
          `;
          const tdAction = tr.querySelector("td:last-child");

          const resetBtn = h("button", { class:"btn small soft", html:"Reset user", onclick:()=>{
            state.progress[u] = makeFreshProgress(state.users[u]?.createdAt || now());
            Object.keys(state.sync.status).forEach(k=>{ if (k.startsWith(u + ":")) delete state.sync.status[k]; });
            saveState(); showToast(`ƒê√£ reset: ${u}`); render();
          }});

          const delBtn = h("button", { class:"btn small warn", html:"X√≥a", onclick:()=>{
            if (!confirm(`X√≥a user ${u}? (Kh√¥ng th·ªÉ kh√¥i ph·ª•c)`)) return;
            delete state.users[u];
            delete state.progress[u];
            Object.keys(state.sync.status).forEach(k=>{ if (k.startsWith(u + ":")) delete state.sync.status[k]; });
            if (state.session.currentUser === u) state.session.currentUser = null;
            saveState(); showToast(`ƒê√£ x√≥a: ${u}`); render();
          }});

          tdAction.append(resetBtn, document.createTextNode(" "), delBtn);
          tbody.appendChild(tr);
        }

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>User</th><th>Avatar</th><th>ƒêi·ªÉm</th><th>Ho√†n th√†nh</th><th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
        `;
        table.appendChild(tbody);
        card3.append(h("div",{style:"height:10px;"}), table);

        wrap.append(card, card2, card3);
        return wrap;
      }

      function adminWebhookPanel(){
        const wrap = h("div", { class:"col", style:"gap:12px;" });
        const card = h("div", { style:"padding:14px; border-radius:18px; background:rgba(255,255,255,.70); outline:1px solid rgba(255,255,255,.35);" });

        card.append(
          h("div",{class:"title", html:"C·∫•u h√¨nh Web App (ghi d·ªØ li·ªáu l√™n Google Sheet)"}),
          h("div",{class:"subtitle", html:`D√°n ƒë√∫ng Apps Script Web App URL. Ng∆∞·ªùi ch∆°i <b>kh√¥ng th·∫•y tr·∫°ng th√°i sheet</b>.`})
        );

        const link = h("input", { placeholder:"D√°n Web App URL...", value: getWebhookUrl() });

        const saveBtn = h("button", { class:"btn dark", html:"L∆∞u URL", onclick:()=>{
          state.settings.webhookUrl = (link.value||"").trim();
          saveState(); showToast("ƒê√£ l∆∞u Web App URL.");
        }});
        const openBtn = h("button", { class:"btn soft", html:"M·ªü Web App", onclick:()=>{
          const l = (link.value||"").trim();
          if (!l) return showToast("Ch∆∞a c√≥ URL.");
          window.open(l, "_blank");
        }});
        const testBtn = h("button", { class:"btn dark", html:"Test g·ª≠i", onclick: async ()=>{
          const l = (link.value||"").trim();
          if (!l) return showToast("Ch∆∞a c√≥ URL.");
          state.settings.webhookUrl = l; saveState();
          const payload = { user:"ADMIN_TEST", day:0, content:"Test webhook t·ª´ admin", point:0, totalPointAfter:0, completedAtISO:new Date().toISOString() };
          const sent = await sendToWebhook(payload);
          showToast(sent.ok ? "‚úÖ ƒê√£ g·ª≠i test (h√£y ki·ªÉm tra Sheet)." : "‚ùå Test th·∫•t b·∫°i. Ki·ªÉm tra Deploy Web App.");
        }});
        const exportBtn = h("button", { class:"btn soft", html:"Export CSV d·ª± ph√≤ng", onclick: exportResultsCSV });

        card.append(h("div",{style:"height:10px;"}), link, h("div",{style:"height:10px;"}), h("div",{class:"row"}, [saveBtn, openBtn, testBtn, exportBtn]));
        wrap.append(card);
        return wrap;
      }

      function adminDashPanel(){
        const wrap = h("div", { class:"col", style:"gap:12px;" });
        const card = h("div", { style:"padding:14px; border-radius:18px; background:rgba(255,255,255,.70); outline:1px solid rgba(255,255,255,.35);" });

        card.append(
          h("div",{class:"title", html:"Dashboard"}),
          h("div",{class:"subtitle", html:"Th·ª© h·∫°ng theo ƒëi·ªÉm & th·ªùi gian ƒë·∫°t m·ªëc ƒëi·ªÉm."})
        );

        const lb = computeLeaderboard();
        const tbody = h("tbody");

        lb.slice(0, 50).forEach((r, i)=>{
          const dt = new Date(r.reachedAt).toLocaleString("vi-VN");
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${i+1}</b></td>
            <td><span class="mono">${esc(r.user)}</span></td>
            <td>‚≠ê ${r.points}</td>
            <td>${esc(dt)}</td>
          `;
          tbody.appendChild(tr);
        });

        const table = document.createElement("table");
        table.innerHTML = `
          <thead><tr><th>#</th><th>User</th><th>ƒêi·ªÉm</th><th>M·ªëc ƒëi·ªÉm ƒë·∫°t l√∫c</th></tr></thead>
        `;
        table.appendChild(tbody);

        card.append(h("div",{style:"height:10px;"}), table);
        wrap.append(card);
        return wrap;
      }

      function adminResetPanel(){
        const wrap = h("div", { class:"col", style:"gap:12px;" });
        const card = h("div", { style:"padding:14px; border-radius:18px; background:rgba(255,255,255,.70); outline:1px solid rgba(255,255,255,.35);" });

        card.append(
          h("div",{class:"title", html:"Reset to√†n b·ªô game"}),
          h("div",{class:"subtitle", html:`Nh·∫≠p m·∫≠t kh·∫©u admin ƒë·ªÉ reset ti·∫øn ƒë·ªô/ƒëi·ªÉm c·ªßa <b>t·∫•t c·∫£</b> ng∆∞·ªùi ch∆°i.`})
        );

        const pass = h("input", { type:"password", placeholder:"Nh·∫≠p m·∫≠t kh·∫©u reset" });
        const btn = h("button", { class:"btn warn", html:"RESET TO√ÄN B·ªò", onclick:()=>{
          if ((pass.value||"").trim() !== CONFIG.ADMIN_PASS) return showToast("Sai m·∫≠t kh·∫©u reset.");
          if (!confirm("B·∫°n ch·∫Øc ch·∫Øn reset to√†n b·ªô ti·∫øn ƒë·ªô & ƒëi·ªÉm c·ªßa t·∫•t c·∫£ ng∆∞·ªùi ch∆°i?")) return;
          for (const u of Object.keys(state.users)){
            state.progress[u] = makeFreshProgress(state.users[u]?.createdAt || now());
          }
          state.sync.status = {};
          state.settings.lastExportAt = 0;
          state.lastQuote = null;
          saveState();
          showToast("ƒê√£ reset to√†n b·ªô. T·∫•t c·∫£ b·∫Øt ƒë·∫ßu l·∫°i t·ª´ Ng√†y 1.");
          render();
        }});

        card.append(h("div",{style:"height:10px;"}), pass, h("div",{style:"height:10px;"}), btn);
        wrap.append(card);
        return wrap;
      }

      // ===== CSV =====
      function downloadText(filename, text){
        const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function downloadTemplateCSV(){
        const lines = [
          "user,password,avatar",
          `example01,${CONFIG.DEFAULT_PASS},M`,
          `example02,${CONFIG.DEFAULT_PASS},F`,
        ];
        downloadText("dare_to_read_accounts_template.csv", lines.join("\n"));
      }

      function parseCSV(text){
        const out = [];
        let row=[], cur="", inQ=false;
        for (let i=0;i<text.length;i++){
          const ch=text[i], next=text[i+1];
          if (inQ){
            if (ch === '"' && next === '"'){ cur+='"'; i++; continue; }
            if (ch === '"'){ inQ=false; continue; }
            cur += ch;
          }else{
            if (ch === '"'){ inQ=true; continue; }
            if (ch === ','){ row.push(cur); cur=""; continue; }
            if (ch === '\r') continue;
            if (ch === '\n'){ row.push(cur); out.push(row); row=[]; cur=""; continue; }
            cur += ch;
          }
        }
        if (cur.length || row.length){ row.push(cur); out.push(row); }
        return out.filter(r => r.some(c => String(c).trim().length));
      }

      function importCSV(file){
        if (!file) return showToast("Vui l√≤ng ch·ªçn file CSV.");
        const reader = new FileReader();
        reader.onload = () => {
          const text = String(reader.result || "");
          const rows = parseCSV(text);
          if (!rows.length) return showToast("CSV r·ªóng ho·∫∑c kh√¥ng ƒë·ªçc ƒë∆∞·ª£c.");
          let imported = 0;

          for (let i=0;i<rows.length;i++){
            const r = rows[i];
            if (i===0 && String(r[0]||"").toLowerCase().includes("user")) continue;
            const u = normalizeUserAd(r[0]||"");
            if (!u) continue;
            const p = (r[1] || CONFIG.DEFAULT_PASS).trim() || CONFIG.DEFAULT_PASS;
            const a = (String(r[2]||"M").trim().toUpperCase()==="F") ? "F" : "M";

            state.users[u] = { pass:p, avatar:a, createdAt: state.users[u]?.createdAt || now() };
            ensureUser(u);
            imported++;
          }
          saveState();
          showToast(`ƒê√£ import ${imported} t√†i kho·∫£n.`);
          render();
        };
        reader.readAsText(file, "utf-8");
      }

      function csvCell(s){
        const t = String(s ?? "");
        if (/[,"\n]/.test(t)) return `"${t.replace(/"/g,'""')}"`;
        return t;
      }

      function exportResultsCSV(){
        const rows = [];
        rows.push(["user","day","content","completedAtISO","point","totalPointAfter"].join(","));
        for (const u of Object.keys(state.users)){
          ensureUser(u);
          const prog = state.progress[u];
          let running = 0;
          for (let d=1; d<=CONFIG.DAYS; d++){
            const rec = prog.days[d];
            if (!rec) continue;
            running += rec.point || 1;
            const iso = new Date(rec.completedAt).toISOString();
            rows.push([csvCell(u), d, csvCell(rec.content), iso, (rec.point||1), running].join(","));
          }
        }
        state.settings.lastExportAt = now();
        saveState();
        downloadText("dare_to_read_results.csv", rows.join("\n"));
        showToast("ƒê√£ export CSV k·∫øt qu·∫£.");
      }

      // ===== Render =====
      function render(){
        if (view === View.LOGIN) buildLogin();
        else if (view === View.HOME) buildHome();
        else if (view === View.DAY) buildDay();
        else if (view === View.DONE) buildDone();
        else if (view === View.ADMIN_LOGIN) buildAdminLogin();
        else if (view === View.ADMIN) buildAdmin();
      }

      // ===== Init =====
      if (state.session.currentUser && state.users[state.session.currentUser]){
        view = View.HOME;
        currentDay = getNextPlayableDay(state.session.currentUser);
      }else{
        view = View.LOGIN;
      }
      if (!state.settings.webhookUrl){
        state.settings.webhookUrl = CONFIG.WEBHOOK_URL;
        saveState();
      }
      render();
    })();
  </script>
</body>
</html>
